<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grandmaster Pro | Ultimate Chess Manager</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1b1d24">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Grandmaster Pro","short_name":"Grandmaster","start_url":".","display":"standalone","background_color":"#1b1d24","theme_color":"#d4af37","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3002/3002626.png","sizes":"512x512","type":"image/png"}]}' />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        /* --- TEMA MOTORU & GLASSMORPHISM --- */
        :root {
            --bg-gradient: linear-gradient(135deg, #0f1014 0%, #222530 100%);
            --glass-panel: rgba(27, 29, 36, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-card: rgba(255, 255, 255, 0.03);
            --glass-input: rgba(0, 0, 0, 0.2);
            
            --primary: #d4af37;
            --primary-hover: #eac64f;
            --accent: #00f2ff;
            --text-main: #e0e0e0;
            --text-muted: #aaa;
            --success: #4caf50;
            --danger: #ff4d4d;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --font: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --rank1-bg: rgba(255, 215, 0, 0.15);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --glass-panel: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-card: rgba(255, 255, 255, 0.5);
            --glass-input: rgba(255, 255, 255, 0.8);
            
            --primary: #b8860b; 
            --accent: #007bff; 
            --text-main: #1a1a1a;
            --text-muted: #555;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        [data-theme="wood"] { 
            --bg-gradient: url('https://img.freepik.com/free-photo/wood-texture-background_1154-645.jpg'); /* Basit bir ahşap dokusu URL'si veya gradient */
            --glass-panel: rgba(62, 39, 35, 0.85);
            --glass-card: rgba(0,0,0,0.2);
            --primary:#ffb74d; --accent:#8d6e63; --text-main:#ffe0b2; 
        }
        
        [data-theme="cyber"] { 
            --bg-gradient: linear-gradient(45deg, #000000, #1a0b2e);
            --glass-panel: rgba(10, 10, 10, 0.7);
            --glass-card: rgba(20, 20, 20, 0.6);
            --primary:#f0f; --accent:#0f9; --glass-border: #f0f;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font); outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-gradient); 
            background-attachment: fixed; 
            background-size: cover;
            color: var(--text-main); 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 20px; 
            overscroll-behavior: none; 
        }
        
        /* GLASSMORPHISM CLASS */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .app-container { 
            width: 100%; max-width: 1000px; 
            min-height: 650px; 
            padding: 30px; 
            position: relative; overflow: hidden; 
            display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }

        h1, h2, h3 { color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        /* Buttons */
        button { 
            background: var(--primary); color: #121212; border: none; padding: 12px 20px; border-radius: 8px; 
            font-weight: bold; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s, filter 0.2s; 
            text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:hover { filter: brightness(1.1); box-shadow: 0 6px 12px rgba(var(--primary), 0.4); }
        button:active { transform: scale(0.96); }
        button:disabled { background: #555 !important; color: #888 !important; cursor: not-allowed; transform: none; box-shadow: none; }
        
        button.secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); backdrop-filter: blur(4px); }
        button.secondary:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.1); }
        
        button.icon-btn { padding: 8px 12px; font-size: 1rem; border-radius: 50%; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; }
        button.danger-btn { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        button.danger-btn:hover { background: var(--danger); color: white; }

        .copy-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; margin-left: 10px; box-shadow: none; }
        
        /* Inputs */
        input, select, textarea { 
            width: 100%; padding: 12px; 
            background: var(--glass-input); 
            border: 1px solid var(--glass-border); 
            color: var(--text-main); border-radius: 8px; margin-bottom: 10px; font-size: 1rem; 
            transition: 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.3); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        select option { background: #1b1d24; color: #e0e0e0; }

        /* Avatars */
        .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; justify-items: center; margin-bottom: 20px; }
        .avatar-option { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 2px solid var(--glass-border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.3rem; color: var(--text-muted); transition: 0.3s; }
        .avatar-option:hover { background: rgba(255,255,255,0.1); }
        .avatar-option.selected { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.15); }

        /* Views */
        .view { display: none; animation: fadeIn 0.4s ease-out; flex: 1; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); filter: blur(5px); } to { opacity: 1; transform: translateY(0); filter: blur(0); } }

        /* Dashboard & Cards */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dash-card { 
            background: var(--glass-card); 
            padding: 25px; border-radius: 12px; 
            border: 1px solid var(--glass-border); 
            text-align: center; transition: 0.3s;
        }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); border-color: var(--primary); }
        
        /* Lobby Slots */
        .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .slot-item { 
            background: var(--glass-card); 
            padding: 15px; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; 
            border: 1px solid var(--glass-border);
            border-bottom: 4px solid var(--glass-border); 
            position: relative; transition: 0.3s;
        }
        .slot-item:hover { background: rgba(255,255,255,0.08); }
        .slot-item.taken { border-bottom-color: var(--success); }
        .slot-item.me { border-bottom-color: var(--accent); background: rgba(0, 242, 255, 0.08); }
        
        .kick-btn { position: absolute; top: 5px; right: 5px; background: transparent; color: var(--danger); border: none; box-shadow:none; font-size: 1rem; cursor: pointer; padding: 5px; }
        .leave-seat-btn { margin-top: 5px; font-size: 0.7rem; padding: 4px 8px; border: 1px solid var(--danger); color: var(--danger); background: transparent; border-radius: 4px; cursor: pointer; box-shadow:none; }
        .leave-seat-btn:hover { background: var(--danger); color: white; }

        /* History & Matches */
        .history-list { display: grid; gap: 10px; margin-top: 20px; max-height: 200px; overflow-y: auto; padding-right:5px; }
        .history-list::-webkit-scrollbar { width: 5px; }
        .history-list::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 10px; }
        
        .history-item { background: var(--glass-card); padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; transition:0.2s; }
        .history-item:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); }

        .match-card { 
            background: var(--glass-card); 
            padding: 12px; margin-bottom: 8px; border-radius: 8px; 
            display: flex; align-items: center; border: 1px solid var(--glass-border); 
            position: relative; flex-wrap: wrap; transition: transform 0.2s;
        }
        .match-card:hover { transform: scale(1.01); }
        .match-player { flex: 1; font-weight: 500; display: flex; align-items: center; gap: 8px; overflow: hidden; white-space: nowrap; }
        .match-player.right { justify-content: flex-end; text-align: right; }
        .match-player.me { color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        
        .score-select { width: 80px; height: 40px; padding: 5px; margin: 0 5px; font-weight: bold; font-size: 1rem; text-align: center; text-align-last: center; border-radius: 6px; cursor: pointer; background: rgba(0,0,0,0.4) !important; color: #d4af37 !important; border: 1px solid var(--glass-border); display: inline-block; -webkit-appearance: none; appearance: none; }
        .score-select:disabled { opacity: 0.5; cursor: not-allowed; border-color: transparent; }

        /* Link Area */
        .link-area { width: 100%; margin-top: 8px; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
        .link-input { border: none; background: transparent; padding: 4px; margin: 0; color: var(--accent); width: 100%; font-size: 0.8rem; }
        .watch-btn { background: rgba(255,255,255,0.1); color: var(--primary); border: 1px solid var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; text-decoration: none; display: inline-block; margin-left: 5px; transition:0.2s; }
        .watch-btn:hover { background: var(--primary); color:black; }

        /* Tables & Standings */
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; margin-top: 10px; }
        th { padding: 12px; text-align: center; color: var(--primary); font-size: 0.8rem; text-transform:uppercase; letter-spacing:1px; }
        td { padding: 15px 12px; text-align: center; background: var(--glass-card); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); }
        td:first-child { border-radius: 8px 0 0 8px; border-left: 1px solid var(--glass-border); }
        td:last-child { border-radius: 0 8px 8px 0; border-right: 1px solid var(--glass-border); }
        
        .player-name-cell { cursor: pointer; transition: 0.2s; font-weight: 500; }
        .player-name-cell:hover { color: var(--accent); transform: translateX(5px); }

        @keyframes rainbow { 
            0% { border-color: red; box-shadow: inset 0 0 20px rgba(255,0,0,0.2); }
            50% { border-color: yellow; box-shadow: inset 0 0 20px rgba(255,255,0,0.2); }
            100% { border-color: red; box-shadow: inset 0 0 20px rgba(255,0,0,0.2); }
        }
        .rank-1 td { background: var(--rank1-bg); border-top: 1px solid var(--primary); border-bottom: 1px solid var(--primary); color: #fff; font-weight: bold; }
        .rank-1 td:first-child { border-left: 1px solid var(--primary); } 
        .rank-1 td:last-child { border-right: 1px solid var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .modal-content { background: rgba(30, 30, 35, 0.9); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--primary); box-shadow: 0 0 40px rgba(0,0,0,0.5); position: relative; max-height: 80vh; overflow-y: auto; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .close-modal:hover { color: var(--danger); transform: rotate(90deg); }

        /* CHAT & FLOATING */
        .floating-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: none; flex-direction: column; gap: 10px; align-items: flex-end; }
        .float-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; border: none; backdrop-filter: blur(5px); }
        .float-btn:hover { transform: scale(1.1); }
        .chat-btn { background: var(--primary); color: black; }
        .rules-btn { background: var(--accent); color: black; }
        .chess-btn { background: #7fa650; color: white; }

        .chat-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border: 2px solid #222; display: none; }

        #chatWidget { position: fixed; bottom: 90px; right: 20px; width: 320px; background: rgba(20, 20, 25, 0.95); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 12px; z-index: 1000; display: none; flex-direction: column; max-height: 400px; box-shadow: var(--shadow); }
        #chatMessages { flex: 1; padding: 10px; overflow-y: auto; height: 300px; background: transparent; font-size: 0.9rem; }
        
        /* Top Bar */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; border: 1px solid var(--glass-border); }
        .theme-btn { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(255,255,255,0.5); margin-right: 5px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .theme-btn:hover { transform: scale(1.2); }

        /* Switches */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); background: #fff; position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; border-radius: 50%; transition: 0.4s; }

        /* Responsive */
        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            #chatWidget { width: 90%; right: 5%; bottom: 100px; }
            .avatar-grid { grid-template-columns: repeat(4, 1fr); }
            .app-container { padding: 15px; border-radius: 0; min-height: 100vh; border:none; }
        }
    </style>
</head>
<body>

<div class="app-container glass-panel">
    
    <div class="top-bar">
        <div class="user-info" id="userInfoSection" style="display:none;">
            <span id="currentUserIcon"></span> 
            <span id="currentUserDisplay" style="font-weight:bold;">...</span>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <div class="theme-btn" onclick="setTheme('dark')" style="background:#1b1d24;" title="Karanlık"></div>
            <div class="theme-btn" onclick="setTheme('light')" style="background:#f0f2f5;" title="Aydınlık"></div>
            <div class="theme-btn" onclick="setTheme('wood')" style="background:#5d4037;" title="Ahşap"></div>
            <div class="theme-btn" onclick="setTheme('cyber')" style="background:#ff00ff;" title="Cyber"></div>
            <button class="secondary icon-btn" id="btnLogout" style="display:none; margin-left:10px;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div id="view-auth" class="view active">
        <div style="max-width: 400px; margin: 30px auto; text-align: center;">
            <h1 style="font-size: 2.5rem; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);">Grandmaster</h1>
            <p style="color:var(--text-muted); margin-bottom:30px;">Professional Chess Manager</p>
            
            <div class="dash-card">
                <input type="email" id="emailInput" placeholder="E-posta Adresi">
                <input type="password" id="passwordInput" placeholder="Şifre">
                <div id="registerFields" style="display:none;">
                    <input type="text" id="displayNameInput" placeholder="Oyuncu Adı">
                    <div class="avatar-grid" id="authAvatarGrid"></div>
                    <input type="hidden" id="selectedAvatar" value="fa-chess-pawn">
                </div>
                <button id="btnAuthAction" style="width:100%; margin-top:10px;">GİRİŞ YAP</button>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button id="btnSwitchLogin" class="secondary" style="flex:1; font-size:0.7rem;">Giriş</button>
                    <button id="btnSwitchRegister" class="secondary" style="flex:1; font-size:0.7rem;">Kayıt Ol</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Oyun Menüsü</h2>
            <button class="secondary icon-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
        </div>
        <div class="dashboard-grid">
            <div class="dash-card">
                <h3><i class="fas fa-plus-circle"></i> Yeni Turnuva</h3>
                <input type="text" id="newTournamentName" placeholder="Turnuva Adı (Örn: Haftalık Yıldırım)">
                <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
                    <label style="color:var(--text-muted)">Oyuncu:</label>
                    <select id="playerCount" style="width:auto; margin:0;">
                        <option value="4">4 Kişi</option>
                        <option value="5">5 Kişi</option>
                        <option value="6">6 Kişi</option>
                        <option value="7">7 Kişi</option>
                        <option value="8">8 Kişi</option>
                        <option value="10">10 Kişi</option>
                        <option value="12">12 Kişi</option>
                    </select>
                </div>
                <button id="btnCreateTournament" style="width:100%">OLUŞTUR</button>
            </div>
            <div class="dash-card">
                <h3><i class="fas fa-sign-in-alt"></i> Katıl</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:10px;">Arkadaşından aldığın kodu gir:</p>
                <input type="text" id="joinCodeInput" placeholder="KOD (Örn: A7X2B)" style="text-align:center; letter-spacing:3px; font-weight:bold; text-transform:uppercase;">
                <button id="btnJoinTournament" class="secondary" style="width:100%">GİRİŞ YAP</button>
            </div>
        </div>
        <div style="margin-top:30px;">
            <h3 style="font-size:1rem; border-bottom:1px solid var(--glass-border); padding-bottom:5px;">Turnuvalarım</h3>
            <div id="myTournamentsList" class="history-list"></div>
        </div>
    </div>

    <div id="view-settings" class="view">
        <h2>Profil Ayarları</h2>
        <div class="dash-card" style="max-width:500px; margin:0 auto;">
            <input type="text" id="settingsNameInput" placeholder="İsim">
            <div class="avatar-grid" id="settingsAvatarGrid"></div>
            <input type="hidden" id="settingsSelectedAvatar">
            <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:15px; border-radius:8px; margin-top:20px; border:1px solid var(--glass-border);">
                <span>Oyun Sesleri</span>
                <label class="switch"><input type="checkbox" id="muteSoundToggle"><span class="slider"></span></label>
            </div>
            <button id="btnSaveSettings" onclick="saveSettings()" style="width:100%; margin-top:20px;">KAYDET</button>
            <button class="secondary" onclick="switchView('view-dashboard')" style="width:100%; margin-top:10px;">GERİ DÖN</button>
        </div>
    </div>

    <div id="view-lobby" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="lobbyTitle">Lobi</h2>
            <button class="secondary icon-btn" onclick="leaveTournamentConfirm()"><i class="fas fa-arrow-left"></i></button>
        </div>
        
        <div id="adminControls" style="background:rgba(212, 175, 55, 0.1); padding:15px; margin-bottom:20px; display:none; border-radius:12px; border:1px solid var(--primary);">
            <div style="font-size:1.2rem; color:var(--text-muted); margin-bottom:10px; text-align:center; font-family:monospace; letter-spacing:2px;">
                DAVET KODU: <span id="shareCode" style="color:var(--primary); font-weight:bold; font-size:1.5rem;"></span> 
                <button class="copy-btn" onclick="copyCode()"><i class="fas fa-copy"></i></button>
            </div>
            <button id="btnStartTournament" style="width:100%; box-shadow:0 0 15px rgba(212,175,55,0.4);">TURNUVAYI BAŞLAT</button>
        </div>
        
        <div id="lobbySlots" class="slot-grid"></div>
    </div>

    <div id="view-tournament" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%;">
                <h2 id="activeTournamentTitle" style="margin:0; font-size:1.2rem;">Turnuva</h2>
            </div>
            <div style="display:flex; gap:5px;">
                <button id="btnFinishTournament" class="danger-btn" style="display:none; padding:5px 10px; font-size:0.8rem;">BİTİR</button>
                <button class="secondary icon-btn" onclick="leaveTournamentConfirm()"><i class="fas fa-home"></i></button>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:20px; background:rgba(0,0,0,0.2); padding:5px; border-radius:10px;">
            <button class="secondary" style="flex:1; border:none;" onclick="showTab('fixtures')"><i class="fas fa-list"></i> Fikstür</button>
            <button class="secondary" style="flex:1; border:none;" onclick="showTab('standings')"><i class="fas fa-trophy"></i> Puanlar</button>
        </div>
        
        <div id="tab-fixtures">
            <div id="fixturesList"></div>
        </div>
        
        <div id="tab-standings" style="display:none;">
            <div id="standingsContainer" style="background:var(--glass-card); padding:15px; border-radius:12px; border:1px solid var(--glass-border);">
                <h3 style="text-align:center; font-size:1rem; margin-bottom:10px;">PUAN DURUMU</h3>
                <table>
                    <thead>
                        <tr><th>#</th><th style="text-align:left; padding-left:10px;">OYUNCU</th><th>P</th><th>SB</th><th>O</th><th>G</th><th>B</th><th>M</th></tr>
                    </thead>
                    <tbody id="standingsBody"></tbody>
                </table>
            </div>
            <button class="secondary" onclick="downloadStandings()" style="width:100%; margin-top:15px;"><i class="fas fa-camera"></i> Görüntü Al</button>
        </div>
    </div>

</div>

<div id="rulesModal" class="modal-overlay">
    <div class="modal-content glass-panel" style="text-align:left;">
        <span class="close-modal" onclick="closeRules()">×</span>
        <h3 style="text-align:center;">Turnuva Kuralları</h3>
        <textarea id="rulesText" style="height:150px; resize:none; background:rgba(0,0,0,0.3);" placeholder="Örn: Süre 10+0, touch-move kuralı geçerlidir..."></textarea>
        <div id="rulesReadOnly" style="white-space:pre-wrap; color:var(--text-main); line-height:1.6; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px;"></div>
        <button id="btnSaveRules" style="width:100%; margin-top:10px; display:none;" onclick="saveRules()">GÜNCELLE</button>
    </div>
</div>

<div id="statsModal" class="modal-overlay">
    <div class="modal-content glass-panel">
        <span class="close-modal" onclick="closeStats()">×</span>
        <div id="modalAvatar" style="font-size:3.5rem; color:var(--primary); margin-bottom:10px; filter:drop-shadow(0 0 10px rgba(212,175,55,0.3));"></div>
        <h3 id="modalName" style="color:var(--text-main); margin-bottom:5px;"></h3>
        <div style="width:100%; height:1px; background:var(--glass-border); margin-bottom:15px;"></div>
        <div class="stat-grid">
            <div class="stat-box"><div class="stat-val" id="statWins" style="color:var(--success)">0</div><div class="stat-label">Galibiyet</div></div>
            <div class="stat-box"><div class="stat-val" id="statDraws" style="color:var(--text-muted)">0</div><div class="stat-label">Beraberlik</div></div>
            <div class="stat-box"><div class="stat-val" id="statLosses" style="color:var(--danger)">0</div><div class="stat-label">Mağlubiyet</div></div>
            <div class="stat-box"><div class="stat-val" id="statRate" style="color:var(--accent)">%0</div><div class="stat-label">Başarı</div></div>
        </div>
        <div style="font-size:0.9rem; color:var(--text-muted); background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
            Toplam Puan: <span id="statPoints" style="color:var(--primary); font-weight:bold;">0</span> • SB: <span id="statSB">0</span>
        </div>
    </div>
</div>

<div class="floating-container">
    <a href="https://www.chess.com/play/online" target="_blank" class="float-btn chess-btn" title="Chess.com">
        <i class="fas fa-chess-board"></i>
    </a>
    <div class="float-btn rules-btn" id="rulesBtn" onclick="openRules()" style="display:none;" title="Kurallar">
        <i class="fas fa-scroll"></i>
    </div>
    <div class="float-btn chat-btn" id="chatToggleBtn" title="Sohbet">
        <i class="fas fa-comment-dots"></i>
        <div class="chat-badge" id="chatBadge">!</div>
    </div>
</div>

<div id="chatWidget">
    <div style="padding:15px; background:rgba(255,255,255,0.05); border-bottom:1px solid var(--glass-border); display:flex; justify-content:space-between; color:var(--text-main); border-radius:12px 12px 0 0;">
        <span style="font-weight:bold;">Turnuva Sohbeti</span><i class="fas fa-times" onclick="hideChat()" style="cursor:pointer; opacity:0.7;"></i>
    </div>
    <div id="chatMessages"></div>
    <form id="chatInputArea" style="display:flex; padding:10px; border-top:1px solid var(--glass-border); background:rgba(0,0,0,0.2); border-radius:0 0 12px 12px;">
        <input type="text" id="chatInput" placeholder="Mesaj yaz..." style="margin:0; border-right:none; border-radius:8px 0 0 8px; background:rgba(255,255,255,0.1);" autocomplete="off">
        <button type="submit" style="width:auto; margin:0; border-radius:0 8px 8px 0;"><i class="fas fa-paper-plane"></i></button>
    </form>
</div>

<script type="module">
    import autoAnimate from 'https://cdn.jsdelivr.net/npm/@formkit/auto-animate/index.min.js';
    // Standings body ve lobby container'a animasyon ekle
    const standingsBody = document.getElementById('standingsBody');
    const lobbySlots = document.getElementById('lobbySlots');
    autoAnimate(standingsBody);
    autoAnimate(lobbySlots);
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, updateDoc, query, orderBy, serverTimestamp, deleteDoc, where, arrayUnion, arrayRemove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase Config (User provided)
    const firebaseConfig = {
      apiKey: "AIzaSyDtLQivXHDK0kGkATb9RiDuLCibFPZ8Qyw",
      authDomain: "chess-14580.firebaseapp.com",
      projectId: "chess-14580",
      storageBucket: "chess-14580.firebasestorage.app",
      messagingSenderId: "169513638183",
      appId: "1:169513638183:web:8327b77b1c54b3f26ab102",
      measurementId: "G-6W0TYK3DQR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global State
    let currentUser = null;
    let currentTournamentId = null;
    let currentTournamentData = null;
    let unsubscribeTournament = null;
    let unsubscribeChat = null;
    let previousMatchesStr = "";
    let soundEnabled = true;
    const realSound = new Audio("https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3");

    // --- HELPERS: TOASTIFY & SWEETALERT ---
    
    // Toast Gösterme Fonksiyonu (Alert yerine)
    window.showToast = (msg, type = "info") => {
        let bg = "#333";
        if(type === "success") bg = "linear-gradient(to right, #00b09b, #96c93d)";
        if(type === "error") bg = "linear-gradient(to right, #ff5f6d, #ffc371)";
        if(type === "gold") bg = "linear-gradient(to right, #b8860b, #d4af37)";

        Toastify({
            text: msg,
            duration: 3000,
            gravity: "top", 
            position: "right", 
            stopOnFocus: true,
            style: {
                background: bg,
                borderRadius: "8px",
                boxShadow: "0 4px 15px rgba(0,0,0,0.3)",
                fontWeight: "bold"
            },
        }).showToast();
    };

    // --- THEME & INIT ---
    window.setTheme = (t) => { document.body.setAttribute('data-theme', t); localStorage.setItem('gm_theme', t); };
    window.setTheme(localStorage.getItem('gm_theme') || 'dark');
    soundEnabled = localStorage.getItem('gm_mute') !== 'true';

    const avatarList = ['fa-chess-king', 'fa-chess-queen', 'fa-chess-rook', 'fa-chess-bishop', 'fa-chess-knight', 'fa-chess-pawn', 'fa-user-astronaut', 'fa-dragon', 'fa-fire', 'fa-bolt', 'fa-crown', 'fa-brain', 'fa-ghost', 'fa-robot'];
    function renderAvatars(tid, iid) {
        const c = document.getElementById(tid); c.innerHTML='';
        avatarList.forEach(i => {
            const d=document.createElement('div'); d.className='avatar-option'; d.innerHTML=`<i class="fas ${i}"></i>`;
            d.onclick=()=>{ c.querySelectorAll('.avatar-option').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); document.getElementById(iid).value=i; };
            c.appendChild(d);
        });
        if(c.firstChild) c.firstChild.classList.add('selected');
        document.getElementById(iid).value=avatarList[0];
    }
    renderAvatars('authAvatarGrid','selectedAvatar');

    function makeId(length) {
        let result = ''; const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        for (let i = 0; i < length; i++) result += characters.charAt(Math.floor(Math.random() * characters.length));
        return result;
    }

    // --- AUTH ---
    let isReg = false;
    document.getElementById('btnSwitchLogin').onclick=()=>{isReg=false; toggleAuth();};
    document.getElementById('btnSwitchRegister').onclick=()=>{isReg=true; toggleAuth();};
    function toggleAuth(){ 
        document.getElementById('registerFields').style.display=isReg?'block':'none';
        document.getElementById('btnAuthAction').innerText=isReg?'HESAP OLUŞTUR & GİR':'GİRİŞ YAP';
        // Buton stillerini güncelle
        document.getElementById('btnSwitchLogin').classList.toggle('secondary', isReg);
        document.getElementById('btnSwitchRegister').classList.toggle('secondary', !isReg);
    }
    document.getElementById('btnAuthAction').onclick=async()=>{
        const e=document.getElementById('emailInput').value, p=document.getElementById('passwordInput').value, n=document.getElementById('displayNameInput').value, a=document.getElementById('selectedAvatar').value;
        try {
            if(isReg){ 
                if(!n) throw new Error("İsim girin"); 
                const c=await createUserWithEmailAndPassword(auth,e,p); 
                await updateProfile(c.user,{displayName:n, photoURL:a}); 
                showToast("Kayıt başarılı! Hoş geldin.", "success");
            } else {
                await signInWithEmailAndPassword(auth,e,p);
                showToast("Giriş yapıldı.", "success");
            }
        } catch(err){ 
            showToast(err.message, "error"); 
        }
    };
    document.getElementById('btnLogout').onclick=()=>{
        Swal.fire({
            title: 'Çıkış Yap',
            text: "Oturumu kapatmak istiyor musun?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#d4af37',
            cancelButtonColor: '#555',
            confirmButtonText: 'Evet, Çık',
            cancelButtonText: 'İptal',
            background: 'rgba(30,30,35,0.95)', color: '#fff'
        }).then((result) => { if (result.isConfirmed) signOut(auth); });
    };

    onAuthStateChanged(auth, u=>{
        if(u){ currentUser=u; document.getElementById('userInfoSection').style.display='flex'; document.getElementById('btnLogout').style.display='inline-block'; 
               document.getElementById('currentUserDisplay').innerText=u.displayName; document.getElementById('currentUserIcon').innerHTML=`<i class="fas ${u.photoURL||'fa-chess-pawn'}" style="color:var(--primary)"></i>`;
               switchView('view-dashboard'); loadMyTournaments(); }
        else { currentUser=null; document.getElementById('userInfoSection').style.display='none'; document.getElementById('btnLogout').style.display='none'; switchView('view-auth'); }
    });

    // --- DASHBOARD ---
    function loadMyTournaments(){
        if(!currentUser) return;
        const q = query(collection(db,"tournaments"), where("participantIds","array-contains",currentUser.uid));
        onSnapshot(q, snap=>{
            const l = document.getElementById('myTournamentsList'); l.innerHTML='';
            if(snap.empty) l.innerHTML='<p style="text-align:center; color:var(--text-muted)">Kayıtlı turnuva yok.</p>';
            snap.forEach(d=>{
                const t=d.data();
                const isFin = t.status==='finished';
                let actionBtn = '';
                if(isFin) {
                    actionBtn += `<button class="secondary" style="margin-right:5px; font-size:0.7rem;" onclick="enterTournament('${d.id}')">Görüntüle</button>`;
                    actionBtn += `<button class="secondary" style="font-size:0.7rem; color:var(--danger); border-color:var(--danger);" onclick="removeTournament('${d.id}')">Sil</button>`;
                } else {
                    actionBtn = `<button class="icon-btn secondary" style="border:none" onclick="enterTournament('${d.id}')"><i class="fas fa-chevron-right"></i></button>`;
                }
                l.innerHTML += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold; ${isFin?'color:var(--text-muted); text-decoration:line-through;':''}">${t.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${isFin?'Tamamlandı':(t.status==='active'?'Oynanıyor':'Lobi')} #${d.id}</div>
                        </div>
                        <div>${actionBtn}</div>
                    </div>`;
            });
        });
    }

    window.removeTournament = async(tid) => {
        const res = await Swal.fire({title:'Listeden Kaldır?', text:"Geçmişten silinecek.", icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', background:'rgba(30,30,35,0.95)', color:'#fff'});
        if(res.isConfirmed) {
            await updateDoc(doc(db,"tournaments",tid), { participantIds: arrayRemove(currentUser.uid) });
            showToast("Listeden kaldırıldı", "info");
        }
    };

    document.getElementById('btnCreateTournament').onclick=async()=>{
        const n=document.getElementById('newTournamentName').value, c=parseInt(document.getElementById('playerCount').value);
        if(!n) return showToast("Lütfen bir turnuva adı girin.", "error");
        
        const shortId = makeId(5); // 5 Haneli ID
        const slots=[]; for(let i=0;i<c;i++) slots.push({index:i, name:`Masa ${i+1}`, ownerId:null, avatar:'fa-chair', status:'open'});
        
        await setDoc(doc(db,"tournaments",shortId),{ 
            name:n, creatorId:currentUser.uid, status:'lobby', slots, matches:[], 
            participantIds:[currentUser.uid], rules:"", createdAt:new Date() 
        });
        showToast("Turnuva oluşturuldu!", "success");
        enterTournament(shortId);
    };
    document.getElementById('btnJoinTournament').onclick=()=>{ const id=document.getElementById('joinCodeInput').value.trim().toUpperCase(); if(id) enterTournament(id); };

    // --- LOGIC ---
    window.enterTournament = (id) => {
        currentTournamentId = id;
        unsubscribeTournament = onSnapshot(doc(db,"tournaments",id), snap=>{
            if(!snap.exists()) { showToast("Turnuva bulunamadı.", "error"); leaveTournament(); return; }
            const d=snap.data(); currentTournamentData=d; d.id=snap.id;
            
            document.getElementById('rulesBtn').style.display = 'flex';
            
            // Konfeti (Sadece Bitişte)
            if(d.status==='finished' && previousMatchesStr!=='finished') { 
                confetti({particleCount:200, spread:100, origin:{y:0.6}, colors:['#d4af37', '#ffffff']}); 
                Swal.fire({
                    title: 'Turnuva Bitti!',
                    text: 'Şampiyon belli oldu.',
                    icon: 'success',
                    background: 'rgba(30,30,35,0.95)', color: '#fff',
                    confirmButtonColor: '#d4af37'
                });
            } 
            
            const mStr=JSON.stringify(d.matches);
            if(previousMatchesStr && previousMatchesStr!==mStr && d.status==='active' && soundEnabled) realSound.play().catch(()=>{});
            previousMatchesStr = (d.status==='finished') ? 'finished' : mStr;

            if(d.status==='lobby') { renderLobby(d); switchView('view-lobby'); }
            else { renderFixtures(d); renderStandings(d); switchView('view-tournament'); }
        });
        initChat(id);
    };

    function renderLobby(d){
        document.getElementById('lobbyTitle').innerText = d.name;
        document.getElementById('shareCode').innerText = d.id;
        const isAdmin = (d.creatorId===currentUser.uid);
        document.getElementById('adminControls').style.display = isAdmin?'block':'none';
        
        const c=document.getElementById('lobbySlots'); c.innerHTML='';
        d.slots.forEach((s,i)=>{
            const isMe=(s.ownerId===currentUser.uid);
            let h=`<i class="fas ${s.ownerId?s.avatar:'fa-chair'}" style="font-size:2.5rem; margin-bottom:10px; filter:drop-shadow(0 0 5px rgba(255,255,255,0.2)); color:${s.ownerId?(isMe?'var(--accent)':'var(--text-main)'):'#444'}"></i>
                   <div style="font-weight:bold; margin-bottom:5px;">${s.name}</div>`;
            
            if(s.status==='open') {
                const joined = d.slots.some(x=>x.ownerId===currentUser.uid);
                h += !joined ? `<button onclick="claimSlot(${i})" style="width:100%">OTUR</button>` : `<span style="color:var(--text-muted)">Boş</span>`;
            } else {
                h += `<span style="color:${isMe?'var(--accent)':'var(--success)'}; font-weight:bold; font-size:0.8rem;">${isMe?'SEN':'HAZIR'}</span>`;
                if(isAdmin && !isMe) h += `<button class="kick-btn" onclick="kickPlayer(${i})"><i class="fas fa-times"></i></button>`;
                if(isMe && !isAdmin) h += `<button class="leave-seat-btn" onclick="leaveSlot(${i})">KALK</button>`;
                if(isMe && isAdmin) h += `<button class="leave-seat-btn" onclick="leaveSlot(${i})">KALK</button>`;
            }
            const div=document.createElement('div'); div.className=`slot-item ${s.status==='taken'?'taken':''} ${isMe?'me':''}`; div.innerHTML=h;
            c.appendChild(div);
        });
    }

    window.claimSlot = async(i) => {
        const s=[...currentTournamentData.slots]; if(s[i].status!=='open') return;
        s[i]={ index:i, name:currentUser.displayName, ownerId:currentUser.uid, avatar:currentUser.photoURL||'fa-chess-pawn', status:'taken' };
        await updateDoc(doc(db,"tournaments",currentTournamentId), { slots:s, participantIds:arrayUnion(currentUser.uid) });
    };

    window.leaveSlot = async(i) => {
        const s=[...currentTournamentData.slots];
        s[i]={ index:i, name:`Masa ${i+1}`, ownerId:null, avatar:'fa-chair', status:'open' };
        await updateDoc(doc(db,"tournaments",currentTournamentId), { slots:s }); 
    };

    window.kickPlayer = async(i) => {
        const res = await Swal.fire({title:'Atılsın mı?', text:"Oyuncuyu masadan kaldıracaksınız.", icon:'warning', showCancelButton:true, background:'rgba(30,30,35,0.95)', color:'#fff', confirmButtonColor:'#d33'});
        if(!res.isConfirmed) return;
        const s=[...currentTournamentData.slots]; const uidToRemove = s[i].ownerId;
        s[i]={ index:i, name:`Masa ${i+1}`, ownerId:null, avatar:'fa-chair', status:'open' };
        await updateDoc(doc(db,"tournaments",currentTournamentId), { slots:s, participantIds:arrayRemove(uidToRemove) });
    };

    document.getElementById('btnStartTournament').onclick=async()=>{
        const res = await Swal.fire({
            title: 'Turnuva Başlatılıyor',
            text: "Boş masalara 'CPU' atanacak ve fikstür oluşturulacak.",
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'BAŞLAT',
            confirmButtonColor: '#d4af37',
            background: 'rgba(30,30,35,0.95)', color: '#fff'
        });
        if(!res.isConfirmed) return;

        let s=[...currentTournamentData.slots];
        s.forEach((x,i)=>{ if(x.status==='open'){ x.name=`Bot ${i+1}`; x.avatar='fa-robot'; x.status='cpu'; } });
        
        let players = s.map((_,i)=>i);
        if(players.length % 2 !== 0) players.push(-1); // BYE

        const m=[]; const n=players.length; const rounds = n-1; let id=1;
        // Round Robin
        for(let r=1; r<=rounds; r++){ 
            for(let i=0; i<n/2; i++){
                const p1 = players[i]; const p2 = players[n-1-i];
                if(p1 === -1 || p2 === -1) { m.push({id:id++, r, p1:(p1===-1?p2:p1), p2:-1, res:1, link:'', isBye:true}); } 
                else { m.push({id:id++, r, p1:p1, p2:p2, res:null, link:'', isBye:false}); }
            }
            players.splice(1, 0, players.pop());
        }
        // Double Round
        const firstHalfMatches = [...m];
        firstHalfMatches.forEach(x => {
             if(x.isBye) { m.push({id:id++, r:x.r+rounds, p1:x.p1, p2:-1, res:1, link:'', isBye:true}); } 
             else { m.push({id:id++, r:x.r+rounds, p1:x.p2, p2:x.p1, res:null, link:'', isBye:false}); }
        });

        await updateDoc(doc(db,"tournaments",currentTournamentId), { status:'active', slots:s, matches:m });
        showToast("Turnuva Başladı! Başarılar.", "gold");
    };

    document.getElementById('btnFinishTournament').onclick=async()=>{
        const res = await Swal.fire({title:'Turnuva Bitirilsin mi?', text:'Geri alınamaz!', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', background:'rgba(30,30,35,0.95)', color:'#fff'});
        if(res.isConfirmed) await updateDoc(doc(db,"tournaments",currentTournamentId), { status:'finished' });
    };

    function renderFixtures(d){
        document.getElementById('activeTournamentTitle').innerText = d.name;
        const isAdmin = (d.creatorId===currentUser.uid);
        const isFin = d.status==='finished';
        document.getElementById('btnFinishTournament').style.display = (isAdmin && !isFin) ? 'block' : 'none';
        
        const c=document.getElementById('fixturesList'); c.innerHTML='';
        const gr={}; d.matches.forEach(m=>{ if(!gr[m.r]) gr[m.r]=[]; gr[m.r].push(m); });
        
        Object.keys(gr).sort((a,b)=>a-b).forEach(r=>{
            const div=document.createElement('div');
            div.innerHTML=`<div style="background:var(--glass-card); padding:8px; margin-bottom:5px; border-left:4px solid var(--primary); font-weight:bold; color:var(--text-main); font-size:0.9rem;">TUR ${r}</div>`;
            gr[r].forEach(m=>{
                if(m.isBye) {
                     const p1=d.slots[m.p1];
                     div.innerHTML += `
                     <div class="match-card" style="opacity:0.6">
                        <div class="match-player"><i class="fas ${p1.avatar}"></i> ${p1.name}</div>
                        <span style="font-weight:bold; color:var(--success); margin:0 10px;">BAY</span>
                        <div class="match-player right" style="color:var(--text-muted)">-</div>
                     </div>`;
                     return;
                }
                const p1=d.slots[m.p1], p2=d.slots[m.p2];
                const isP1=(p1.ownerId===currentUser.uid), isP2=(p2.ownerId===currentUser.uid);
                const canEdit = isAdmin && !isFin; 
                
                let lnk=''; 
                const watch = m.link ? `<a href="${m.link}" target="_blank" class="watch-btn"><i class="fas fa-eye"></i> İzle</a>` : '';
                const inp = ((isP1||isAdmin) && !isFin) ? `<input class="link-input" placeholder="Maç Linki (Lichess/Chess.com)..." value="${m.link||''}" onchange="upLink(${m.id},this.value)">` : '';
                if(watch||inp) lnk=`<div class="link-area">${watch}${inp}</div>`;

                div.innerHTML += `
                <div class="match-card">
                    <div class="match-player ${isP1?'me':''}"><i class="fas ${p1.avatar}"></i> ${p1.name}</div>
                    <select class="score-select" ${canEdit?'':'disabled'} onchange="upMatch(${m.id},this.value)">
                        <option value="">vs</option><option value="1" ${m.res===1?'selected':''}>1 - 0</option>
                        <option value="0" ${m.res===0?'selected':''}>½ - ½</option><option value="2" ${m.res===2?'selected':''}>0 - 1</option>
                    </select>
                    <div class="match-player right ${isP2?'me':''}">${p2.name} <i class="fas ${p2.avatar}"></i></div>
                    ${lnk}
                </div>`;
            });
            c.appendChild(div);
        });
    }

    window.upMatch = async(id,v)=>{ await updateDoc(doc(db,"tournaments",currentTournamentId), { matches:currentTournamentData.matches.map(m=>m.id===id?{...m,res:v===""?null:parseInt(v)}:m) }); };
    window.upLink = async(id,v)=>{ await updateDoc(doc(db,"tournaments",currentTournamentId), { matches:currentTournamentData.matches.map(m=>m.id===id?{...m,link:v.trim()}:m) }); };

    function renderStandings(d){
        const stats = d.slots.map((s,i)=>({ ...s, idx:i, p:0, w:0, d:0, l:0, pts:0, sb:0 }));
        d.matches.forEach(m=>{
            if(m.res !== null){
                if(m.isBye) { stats[m.p1].p++; stats[m.p1].w++; stats[m.p1].pts+=1; } 
                else {
                    stats[m.p1].p++; stats[m.p2].p++;
                    if(m.res===1) { stats[m.p1].w++; stats[m.p1].pts+=1; stats[m.p2].l++; }
                    else if(m.res===2) { stats[m.p2].w++; stats[m.p2].pts+=1; stats[m.p1].l++; }
                    else { stats[m.p1].d++; stats[m.p1].pts+=0.5; stats[m.p2].d++; stats[m.p2].pts+=0.5; }
                }
            }
        });
        // Sonneborn-Berger
        d.matches.forEach(m=>{
            if(m.res !== null && !m.isBye){
                if(m.res===1) stats[m.p1].sb += stats[m.p2].pts; 
                else if(m.res===2) stats[m.p2].sb += stats[m.p1].pts; 
                else { stats[m.p1].sb += 0.5 * stats[m.p2].pts; stats[m.p2].sb += 0.5 * stats[m.p1].pts; }
            }
        });
        
        stats.sort((a,b)=> b.pts - a.pts || b.sb - a.sb || b.w - a.w);
        const b=document.getElementById('standingsBody'); b.innerHTML='';
        const isFin = d.status==='finished';

        stats.forEach((s,rank)=>{
            let rowClass = '';
            if(isFin){ if(rank===0) rowClass='rank-1'; }
            else if(s.ownerId===currentUser.uid) rowClass='me'; 

            const tr=document.createElement('tr'); tr.className=rowClass;
            if(s.ownerId===currentUser.uid && !isFin) tr.style.background='rgba(0, 242, 255, 0.1)';
            
            tr.innerHTML = `
                <td>${rank+1}</td>
                <td class="player-name-cell" onclick='showStats(${JSON.stringify(s)})' style="text-align:left;">
                    <i class="fas ${s.avatar}"></i> ${s.name} ${rank===0&&isFin?'👑':''}
                </td>
                <td style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${s.pts}</td>
                <td style="color:var(--text-muted); font-size:0.9rem;">${s.sb.toFixed(2)}</td>
                <td>${s.p}</td><td style="color:var(--success)">${s.w}</td><td>${s.d}</td><td style="color:var(--danger)">${s.l}</td>
            `;
            b.appendChild(tr);
        });
    }

    // --- UTILS ---
    window.downloadStandings = () => {
        const element = document.getElementById("standingsContainer");
        const originalBg = element.style.background;
        element.style.background = "#1b1d24"; // Reset for clean screenshot
        html2canvas(element, { scale: 2, backgroundColor: "#1b1d24" }).then(canvas => {
            const link = document.createElement("a");
            link.download = `Grandmaster_Puan_${currentTournamentId}.png`;
            link.href = canvas.toDataURL();
            link.click();
            element.style.background = originalBg;
            showToast("Resim indirildi!", "success");
        });
    };

    window.openRules = () => {
        const isAdmin = currentTournamentData.creatorId === currentUser.uid;
        document.getElementById('rulesText').value = currentTournamentData.rules || "";
        document.getElementById('rulesReadOnly').innerText = currentTournamentData.rules || "Henüz kural eklenmedi.";
        document.getElementById('rulesText').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('btnSaveRules').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('rulesReadOnly').style.display = isAdmin ? 'none' : 'block';
        document.getElementById('rulesModal').style.display = 'flex';
    };
    window.closeRules = () => document.getElementById('rulesModal').style.display = 'none';
    window.saveRules = async() => {
        const txt = document.getElementById('rulesText').value;
        await updateDoc(doc(db,"tournaments",currentTournamentId), { rules: txt });
        closeRules();
        showToast("Kurallar güncellendi", "success");
    };

    window.showStats = (s) => {
        document.getElementById('modalAvatar').innerHTML = `<i class="fas ${s.avatar}"></i>`;
        document.getElementById('modalName').innerText = s.name;
        document.getElementById('statWins').innerText = s.w;
        document.getElementById('statDraws').innerText = s.d;
        document.getElementById('statLosses').innerText = s.l;
        document.getElementById('statPoints').innerText = s.pts;
        document.getElementById('statSB').innerText = s.sb.toFixed(2);
        const rate = s.p > 0 ? Math.round((s.w / s.p) * 100) : 0;
        document.getElementById('statRate').innerText = `%${rate}`;
        document.getElementById('statsModal').style.display = 'flex';
    };
    window.closeStats = () => document.getElementById('statsModal').style.display='none';
    window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) { closeStats(); closeRules(); } }

    window.copyCode = () => { navigator.clipboard.writeText(document.getElementById('shareCode').innerText).then(()=>showToast("Kod kopyalandı!", "success")); };
    
    window.leaveTournamentConfirm = async () => {
        const res = await Swal.fire({
            title: 'Çıkış?', 
            text: 'Turnuva ekranından ayrılacaksın.', 
            icon: 'question', 
            showCancelButton: true,
            background: 'rgba(30,30,35,0.95)', color: '#fff',
            confirmButtonColor: '#555', cancelButtonColor: '#d33',
            confirmButtonText: 'Evet, Çık', cancelButtonText: 'Kal'
        });
        if(res.isConfirmed) leaveTournament();
    }

    window.leaveTournament = () => { 
        if(unsubscribeTournament) unsubscribeTournament(); 
        if(unsubscribeChat) unsubscribeChat(); 
        currentTournamentId=null; hideChat(); switchView('view-dashboard'); 
    };

    function switchView(id){ 
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); 
        document.getElementById(id).classList.add('active'); 
        const floatNav = document.querySelector('.floating-container');
        if(id === 'view-lobby' || id === 'view-tournament'){ floatNav.style.display = 'flex'; } 
        else { floatNav.style.display = 'none'; document.getElementById('chatWidget').style.display = 'none'; document.getElementById('chatToggleBtn').style.display = 'flex'; }
    }
    
    window.showTab = (t) => { document.getElementById('tab-fixtures').style.display=t==='fixtures'?'block':'none'; document.getElementById('tab-standings').style.display=t==='standings'?'block':'none'; };
    window.openSettings = () => { renderAvatars('settingsAvatarGrid','settingsSelectedAvatar'); document.getElementById('settingsNameInput').value=currentUser.displayName; switchView('view-settings'); };
    window.saveSettings = async() => { 
        try {
            await updateProfile(currentUser,{displayName:document.getElementById('settingsNameInput').value, photoURL:document.getElementById('settingsSelectedAvatar').value}); 
            showToast("Ayarlar kaydedildi", "success");
            switchView('view-dashboard'); 
        } catch(e){ showToast(e.message, "error"); }
    };
    
    const cw=document.getElementById('chatWidget'), cb=document.getElementById('chatToggleBtn');
    cb.onclick=()=>{ cw.style.display='flex'; cb.style.display='none'; document.getElementById('chatBadge').style.display='none'; scrollChat(); };
    window.hideChat=()=>{ cw.style.display='none'; if(currentTournamentId) cb.style.display='flex'; };
    function initChat(tid){
        cb.style.display='flex'; const q=query(collection(db,`tournaments/${tid}/messages`),orderBy('createdAt','asc'));
        unsubscribeChat=onSnapshot(q,s=>{
            const d=document.getElementById('chatMessages'); d.innerHTML=''; let n=false;
            s.forEach(x=>{ const m=x.data(); const me=m.uid===currentUser.uid; d.innerHTML+=`<div style="text-align:${me?'right':'left'}; margin-bottom:5px;"><strong style="color:${me?'var(--accent)':'var(--primary)'}; font-size:0.8rem;">${m.user}</strong><div style="background:${me?'var(--primary)':'rgba(255,255,255,0.1)'}; color:${me?'#000':'var(--text-main)'}; display:inline-block; padding:5px 10px; border-radius:10px; margin-top:2px; max-width:80%; word-break:break-word;">${m.text}</div></div>`; n=true; });
            scrollChat(); if(n && cw.style.display==='none') document.getElementById('chatBadge').style.display='flex';
        });
    }
    document.getElementById('chatInputArea').onsubmit=async(e)=>{ e.preventDefault(); const i=document.getElementById('chatInput'); if(!i.value.trim()) return; await addDoc(collection(db,`tournaments/${currentTournamentId}/messages`),{text:i.value, user:currentUser.displayName, uid:currentUser.uid, createdAt:serverTimestamp()}); i.value=''; };
    function scrollChat(){ const d=document.getElementById('chatMessages'); d.scrollTop=d.scrollHeight; }

</script>
</body>
</html>