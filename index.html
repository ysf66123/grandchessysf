<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grandmaster Pro | Ultimate Chess Manager</title>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Confetti Efekti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- TEMA MOTORU --- */
        :root {
            /* VarsayÄ±lan (Dark) */
            --bg-body: #0f1014;
            --bg-panel: #1b1d24;
            --primary: #d4af37;
            --primary-hover: #eac64f;
            --accent: #00f2ff;
            --text-main: #e0e0e0;
            --text-muted: #777;
            --border: #333;
            --success: #4caf50;
            --danger: #ff4d4d;
            --card-bg: #252830;
            --shadow: 0 20px 50px rgba(0,0,0,0.6);
            --font: 'Segoe UI', Roboto, sans-serif;
            --chat-bg: #1a1a1a;
            --rank1-bg: rgba(255,215,0,0.1);
        }

        /* TEMA: LIGHT (AYDINLIK) */
        [data-theme="light"] {
            --bg-body: #f0f2f5;
            --bg-panel: #ffffff;
            --primary: #b8860b; 
            --primary-hover: #d4af37;
            --accent: #007bff; 
            --text-main: #1a1a1a;
            --text-muted: #666;
            --border: #dee2e6;
            --success: #28a745;
            --danger: #dc3545;
            --card-bg: #f8f9fa;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --chat-bg: #f1f1f1;
            --rank1-bg: rgba(184, 134, 11, 0.1);
        }

        /* DiÄŸer Temalar */
        [data-theme="wood"] { --bg-body:#4e342e; --bg-panel:#3e2723; --primary:#ffb74d; --accent:#8d6e63; --card-bg:#4e342e; --border:#5d4037; }
        [data-theme="cyber"] { --bg-body:#000; --bg-panel:#09090b; --primary:#f0f; --accent:#0f9; --card-bg:#111; --border:#333; }
        [data-theme="forest"] { --bg-body:#1b5e20; --bg-panel:#2e7d32; --primary:#a5d6a7; --accent:#ffeb3b; --card-bg:#388e3c; --border:#1b5e20; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font); transition: background 0.2s, color 0.2s, border-color 0.2s; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        
        .app-container { width: 100%; max-width: 1000px; background: var(--bg-panel); border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); padding: 30px; position: relative; overflow: hidden; min-height: 600px; display: flex; flex-direction: column; }

        /* UI ELEMENTS */
        h1, h2, h3 { color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
        
        button { background: var(--primary); color: #121212; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.1s, background 0.2s; text-transform: uppercase; font-size: 0.85rem; }
        button:active { transform: scale(0.96); }
        button:disabled { background: #555 !important; color: #888 !important; cursor: not-allowed; transform: none; }
        
        button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        button.secondary:hover { border-color: var(--text-main); color: var(--text-main); }
        
        button.icon-btn { padding: 8px 12px; font-size: 1rem; }
        button.danger-btn { background: rgba(255, 77, 77, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        button.danger-btn:hover { background: var(--danger); color: white; }

        .copy-btn { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; margin-left: 10px; transition: 0.2s; }
        
        input, select, textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.05); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.1); }

        /* AVATAR */
        .avatar-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; justify-items: center; margin-bottom: 20px; }
        .avatar-option { width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.2); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; color: var(--text-muted); transition: 0.2s; }
        .avatar-option.selected { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.1); }

        /* VIEWS */
        .view { display: none; animation: fadeIn 0.3s ease; flex: 1; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dash-card { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        
        /* SLOT GRID */
        .slot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .slot-item { background: var(--card-bg); padding: 15px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; border-bottom: 3px solid var(--border); position: relative; }
        .slot-item.taken { border-bottom-color: var(--success); }
        .slot-item.me { border-bottom-color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        .kick-btn { position: absolute; top: 5px; right: 5px; background: transparent; color: var(--danger); border: none; font-size: 1rem; cursor: pointer; padding: 5px; }
        .kick-btn:hover { transform: scale(1.2); }

        /* HISTORY LIST */
        .history-list { display: grid; gap: 10px; margin-top: 20px; max-height: 200px; overflow-y: auto; }
        .history-item { background: var(--card-bg); padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .history-item:hover { border-color: var(--primary); }

        /* MATCH CARD */
        .match-card { background: var(--card-bg); padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; border: 1px solid var(--border); position: relative; flex-wrap: wrap; }
        .match-player { flex: 1; font-weight: 500; display: flex; align-items: center; gap: 8px; overflow: hidden; white-space: nowrap; }
        .match-player.right { justify-content: flex-end; text-align: right; }
        .match-player.me { color: var(--accent); }
        
        /* --- SKOR SELECT FIX (GÃœNCELLENDÄ°) --- */
        .score-select { 
            /* GÃ¶rÃ¼nÃ¼m sÄ±fÄ±rlama */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* BoyutlandÄ±rma */
            width: 80px; 
            height: 40px; 
            padding: 5px;
            margin: 0 5px; 
            /* Stil */
            font-weight: bold; 
            font-size: 1rem;
            text-align: center; 
            text-align-last: center; 
            border-radius: 6px;
            cursor: pointer;
            /* Renkler (Her zaman koyu arkaplan, altÄ±n yazÄ±) */
            background-color: #1a1a1a !important; 
            color: #d4af37 !important; 
            border: 1px solid var(--border);
            display: inline-block;
        }
        /* Optionlar iÃ§in de renk zorlama */
        .score-select option { background-color: #1a1a1a; color: #d4af37; }
        
        .score-select:disabled { opacity: 0.5; cursor: not-allowed; border-color: transparent; }

        .link-area { width: 100%; margin-top: 8px; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; }
        .link-input { border: none; background: transparent; padding: 4px; margin: 0; color: var(--accent); width: 100%; font-size: 0.8rem; }
        .watch-btn { background: #333; color: var(--primary); border: 1px solid var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; text-decoration: none; display: inline-block; margin-left: 5px; }

        /* TABLE & RANKS */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
        th { color: var(--primary); font-size: 0.8rem; }
        .player-name-cell { cursor: pointer; transition: 0.2s; }
        .player-name-cell:hover { color: var(--accent); text-decoration: underline; }

        /* RGB ANIMATIONS */
        @keyframes rainbow { 
            0% { border-color: red; box-shadow: 0 0 10px red; color: #ff5555; }
            20% { border-color: yellow; box-shadow: 0 0 10px yellow; color: #ffff55; }
            40% { border-color: lime; box-shadow: 0 0 10px lime; color: #55ff55; }
            60% { border-color: cyan; box-shadow: 0 0 10px cyan; color: #55ffff; }
            80% { border-color: magenta; box-shadow: 0 0 10px magenta; color: #ff55ff; }
            100% { border-color: red; box-shadow: 0 0 10px red; color: #ff5555; }
        }
        /* Light Theme iÃ§in Rainbow Rengi biraz daha koyu olsun */
        [data-theme="light"] .rank-1 { color: #d63384; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        
        .rank-1 { animation: rainbow 2s linear infinite; border: 2px solid transparent; font-weight: bold; background: var(--rank1-bg); }
        .rank-2 { border: 1px solid silver; box-shadow: 0 0 8px silver; background: rgba(192,192,192,0.1); color: var(--text-main); }
        .rank-3 { border: 1px solid #cd7f32; box-shadow: 0 0 8px #cd7f32; background: rgba(205,127,50,0.1); color: var(--text-main); }

        /* STATS MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .modal-content { background: var(--bg-panel); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--primary); box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); position: relative; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-box { background: var(--card-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }

        /* CHAT */
        #chatWidget { position: fixed; bottom: 20px; right: 20px; width: 320px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; z-index: 1000; display: none; flex-direction: column; max-height: 400px; }
        #chatMessages { flex: 1; padding: 10px; overflow-y: auto; height: 300px; background: var(--chat-bg); font-size: 0.9rem; }
        .chat-toggle-btn { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: black; display: none; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; z-index: 999; }
        .chat-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-body); display: none; }

        /* Top Bar & Switch */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .theme-btn { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; margin-right: 5px; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); background: #fff; position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; border-radius: 50%; transition: 0.4s; }

        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            #chatWidget { width: 90%; right: 5%; bottom: 80px; }
            .avatar-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="top-bar">
        <div class="user-info" id="userInfoSection" style="display:none;">
            <span id="currentUserIcon"></span> 
            <span id="currentUserDisplay">...</span>
        </div>
        <div>
            <!-- Tema ButonlarÄ± -->
            <div class="theme-btn" onclick="setTheme('dark')" style="background:#1b1d24;" title="KaranlÄ±k"></div>
            <div class="theme-btn" onclick="setTheme('light')" style="background:#f0f2f5;" title="AydÄ±nlÄ±k"></div>
            <div class="theme-btn" onclick="setTheme('wood')" style="background:#5d4037;" title="AhÅŸap"></div>
            <div class="theme-btn" onclick="setTheme('cyber')" style="background:#ff00ff;" title="Neon"></div>
            <button class="secondary icon-btn" id="btnLogout" style="display:none;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <!-- 1. AUTH -->
    <div id="view-auth" class="view active">
        <div style="max-width: 400px; margin: 30px auto; text-align: center;">
            <h1>Grandmaster</h1>
            <p style="color:var(--text-muted);">Ultimate Chess Manager</p>
            <div id="authError" style="color:var(--danger); margin:10px 0;"></div>
            <input type="email" id="emailInput" placeholder="E-posta">
            <input type="password" id="passwordInput" placeholder="Åžifre">
            <div id="registerFields" style="display:none;">
                <input type="text" id="displayNameInput" placeholder="Oyuncu AdÄ±">
                <div class="avatar-grid" id="authAvatarGrid"></div>
                <input type="hidden" id="selectedAvatar" value="fa-chess-pawn">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="btnSwitchLogin" class="secondary" style="flex:1;">GiriÅŸ</button>
                <button id="btnSwitchRegister" class="secondary" style="flex:1;">KayÄ±t</button>
            </div>
            <button id="btnAuthAction" style="width:100%; margin-top:10px;">GÄ°RÄ°Åž YAP</button>
        </div>
    </div>

    <!-- 2. DASHBOARD (OYUN MENÃœSÃœ) -->
    <div id="view-dashboard" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Oyun MenÃ¼sÃ¼</h2>
            <button class="secondary" onclick="openSettings()"><i class="fas fa-cog"></i></button>
        </div>
        <div class="dashboard-grid">
            <div class="dash-card">
                <h3>Turnuva Kur</h3>
                <input type="text" id="newTournamentName" placeholder="Turnuva AdÄ±">
                <select id="playerCount" style="width:auto; margin:0 auto 15px auto;">
                    <option value="4">4 KiÅŸi (Ã‡ift Devre)</option>
                    <option value="6">6 KiÅŸi (Ã‡ift Devre)</option>
                    <option value="8">8 KiÅŸi (Ã‡ift Devre)</option>
                </select>
                <button id="btnCreateTournament">OLUÅžTUR</button>
            </div>
            <div class="dash-card">
                <h3>KatÄ±l</h3>
                <input type="text" id="joinCodeInput" placeholder="Turnuva ID">
                <button id="btnJoinTournament" class="secondary">GÄ°T</button>
            </div>
        </div>
        <div style="margin-top:30px;">
            <h3 style="font-size:1rem; border-bottom:1px solid var(--border); padding-bottom:5px;">TurnuvalarÄ±m</h3>
            <div id="myTournamentsList" class="history-list"></div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="view">
        <h2>Ayarlar</h2>
        <div style="max-width:500px; margin:0 auto;">
            <input type="text" id="settingsNameInput" placeholder="Ä°sim">
            <div class="avatar-grid" id="settingsAvatarGrid"></div>
            <input type="hidden" id="settingsSelectedAvatar">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card-bg); padding:15px; border-radius:8px; margin-top:20px; border:1px solid var(--border);">
                <span>Oyun Sesleri</span>
                <label class="switch"><input type="checkbox" id="muteSoundToggle"><span class="slider"></span></label>
            </div>
            <!-- KAYDET ve GERÄ° ButonlarÄ± -->
            <button id="btnSaveSettings" onclick="saveSettings()" style="width:100%; margin-top:20px;">KAYDET</button>
            <button id="btnBackSettings" class="secondary" onclick="switchView('view-dashboard')" style="width:100%; margin-top:10px;">GERÄ°</button>
        </div>
    </div>

    <!-- 3. LOBBY -->
    <div id="view-lobby" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="lobbyTitle">Lobi</h2>
            <button class="secondary" onclick="leaveTournament()"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div id="adminControls" style="background:rgba(100,100,100,0.1); padding:15px; margin-bottom:20px; display:none; border-radius:8px; border:1px solid var(--border);">
            <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">ID: <span id="shareCode" style="color:var(--text-main);"></span> <button class="copy-btn" onclick="copyCode()">Kopyala</button></div>
            <button id="btnStartTournament" style="width:100%;">BAÅžLAT</button>
        </div>
        <div id="lobbySlots" class="slot-grid"></div>
    </div>

    <!-- 4. TOURNAMENT -->
    <div id="view-tournament" class="view">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="activeTournamentTitle">Turnuva</h2>
            <div style="display:flex; gap:5px;">
                <button id="btnFinishTournament" class="danger-btn" style="display:none; padding:5px 10px; font-size:0.8rem;">BÄ°TÄ°R</button>
                <button class="secondary" onclick="leaveTournament()"><i class="fas fa-home"></i></button>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="secondary" style="flex:1;" onclick="showTab('fixtures')">FikstÃ¼r</button>
            <button class="secondary" style="flex:1;" onclick="showTab('standings')">Puan Durumu</button>
        </div>
        <div id="tab-fixtures"><div id="fixturesList"></div></div>
        <div id="tab-standings" style="display:none;">
            <table>
                <thead>
                    <tr><th>#</th><th style="text-align:left;">Oyuncu</th><th>P</th><th>SB</th><th>O</th><th>G</th><th>B</th><th>M</th></tr>
                </thead>
                <tbody id="standingsBody"></tbody>
            </table>
        </div>
    </div>

</div>

<!-- STATS MODAL -->
<div id="statsModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeStats()">Ã—</span>
        <div id="modalAvatar" style="font-size:3rem; color:var(--primary); margin-bottom:10px;"></div>
        <h3 id="modalName" style="color:var(--text-main);"></h3>
        <div class="stat-grid">
            <div class="stat-box"><div class="stat-val" id="statWins">0</div><div class="stat-label">Galibiyet</div></div>
            <div class="stat-box"><div class="stat-val" id="statDraws">0</div><div class="stat-label">Beraberlik</div></div>
            <div class="stat-box"><div class="stat-val" id="statLosses">0</div><div class="stat-label">MaÄŸlubiyet</div></div>
            <div class="stat-box"><div class="stat-val" id="statRate">%0</div><div class="stat-label">Kazanma OranÄ±</div></div>
        </div>
        <div style="font-size:0.9rem; color:var(--text-muted);">Puan: <span id="statPoints" style="color:var(--primary)">0</span> â€¢ SB: <span id="statSB">0</span></div>
    </div>
</div>

<!-- CHAT -->
<div class="chat-toggle-btn" id="chatToggleBtn"><i class="fas fa-comment-dots"></i><div class="chat-badge" id="chatBadge">!</div></div>
<div id="chatWidget">
    <div style="padding:10px; background:var(--bg-panel); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; color:var(--text-main);">
        <span>Sohbet</span><i class="fas fa-times" onclick="hideChat()" style="cursor:pointer;"></i>
    </div>
    <div id="chatMessages"></div>
    <form id="chatInputArea" style="display:flex; padding:10px; border-top:1px solid var(--border); background:var(--bg-panel);">
        <input type="text" id="chatInput" placeholder="Yaz..." style="margin:0; border-right:none; border-radius:4px 0 0 4px;">
        <button type="submit" style="width:auto; margin:0; border-radius:0 4px 4px 0;"><i class="fas fa-paper-plane"></i></button>
    </form>
</div>

<!-- FIREBASE SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, query, orderBy, serverTimestamp, deleteDoc, where, arrayUnion, arrayRemove } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDtLQivXHDK0kGkATb9RiDuLCibFPZ8Qyw",
      authDomain: "chess-14580.firebaseapp.com",
      projectId: "chess-14580",
      storageBucket: "chess-14580.firebasestorage.app",
      messagingSenderId: "169513638183",
      appId: "1:169513638183:web:8327b77b1c54b3f26ab102",
      measurementId: "G-6W0TYK3DQR"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentTournamentId = null;
    let currentTournamentData = null;
    let unsubscribeTournament = null;
    let unsubscribeChat = null;
    let previousMatchesStr = "";
    let soundEnabled = true;
    const realSound = new Audio("https://codeskulptor-demos.commondatastorage.googleapis.com/pang/pop.mp3");

    // INIT
    window.setTheme = (t) => { document.body.setAttribute('data-theme', t); localStorage.setItem('gm_theme', t); };
    window.setTheme(localStorage.getItem('gm_theme') || 'dark');
    soundEnabled = localStorage.getItem('gm_mute') !== 'true';

    const avatarList = ['fa-chess-king', 'fa-chess-queen', 'fa-chess-rook', 'fa-chess-bishop', 'fa-chess-knight', 'fa-chess-pawn', 'fa-user-astronaut', 'fa-dragon', 'fa-fire', 'fa-bolt', 'fa-crown', 'fa-brain'];
    function renderAvatars(tid, iid) {
        const c = document.getElementById(tid); c.innerHTML='';
        avatarList.forEach(i => {
            const d=document.createElement('div'); d.className='avatar-option'; d.innerHTML=`<i class="fas ${i}"></i>`;
            d.onclick=()=>{ c.querySelectorAll('.avatar-option').forEach(e=>e.classList.remove('selected')); d.classList.add('selected'); document.getElementById(iid).value=i; };
            c.appendChild(d);
        });
        if(c.firstChild) c.firstChild.classList.add('selected');
        document.getElementById(iid).value=avatarList[0];
    }
    renderAvatars('authAvatarGrid','selectedAvatar');

    // AUTH
    let isReg = false;
    document.getElementById('btnSwitchLogin').onclick=()=>{isReg=false; toggleAuth();};
    document.getElementById('btnSwitchRegister').onclick=()=>{isReg=true; toggleAuth();};
    function toggleAuth(){ 
        document.getElementById('registerFields').style.display=isReg?'block':'none';
        document.getElementById('btnAuthAction').innerText=isReg?'KAYIT OL & GÄ°R':'GÄ°RÄ°Åž YAP'; 
    }
    document.getElementById('btnAuthAction').onclick=async()=>{
        const e=document.getElementById('emailInput').value, p=document.getElementById('passwordInput').value, n=document.getElementById('displayNameInput').value, a=document.getElementById('selectedAvatar').value;
        try {
            if(isReg){ if(!n) throw new Error("Ä°sim girin"); const c=await createUserWithEmailAndPassword(auth,e,p); await updateProfile(c.user,{displayName:n, photoURL:a}); location.reload(); }
            else await signInWithEmailAndPassword(auth,e,p);
        } catch(err){ document.getElementById('authError').innerText=err.message; }
    };
    document.getElementById('btnLogout').onclick=()=>signOut(auth);
    onAuthStateChanged(auth, u=>{
        if(u){ currentUser=u; document.getElementById('userInfoSection').style.display='block'; document.getElementById('btnLogout').style.display='inline-block'; 
               document.getElementById('currentUserDisplay').innerText=u.displayName; document.getElementById('currentUserIcon').innerHTML=`<i class="fas ${u.photoURL||'fa-chess-pawn'}" style="color:var(--primary)"></i>`;
               switchView('view-dashboard'); loadMyTournaments(); }
        else { currentUser=null; document.getElementById('userInfoSection').style.display='none'; document.getElementById('btnLogout').style.display='none'; switchView('view-auth'); }
    });

    // DASHBOARD & LISTS
    function loadMyTournaments(){
        if(!currentUser) return;
        const q = query(collection(db,"tournaments"), where("participantIds","array-contains",currentUser.uid));
        onSnapshot(q, snap=>{
            const l = document.getElementById('myTournamentsList'); l.innerHTML='';
            if(snap.empty) l.innerHTML='<p style="text-align:center; color:var(--text-muted)">KayÄ±tlÄ± turnuva yok.</p>';
            snap.forEach(d=>{
                const t=d.data();
                const isFin = t.status==='finished';
                
                let actionBtn = '';
                if(isFin) {
                    actionBtn += `<button class="secondary" style="margin-right:5px; font-size:0.7rem;" onclick="enterTournament('${d.id}')">GÃ¶rÃ¼ntÃ¼le</button>`;
                    actionBtn += `<button class="secondary" style="font-size:0.7rem; color:var(--danger); border-color:var(--danger);" onclick="removeTournament('${d.id}')">KaldÄ±r</button>`;
                } else {
                    actionBtn = `<button class="icon-btn secondary" style="border:none" onclick="enterTournament('${d.id}')"><i class="fas fa-chevron-right"></i></button>`;
                }
                
                l.innerHTML += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold; ${isFin?'color:var(--text-muted); text-decoration:line-through;':''}">${t.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${isFin?'TamamlandÄ±':(t.status==='active'?'OynanÄ±yor':'Lobi')}</div>
                        </div>
                        <div>${actionBtn}</div>
                    </div>`;
            });
        });
    }

    window.removeTournament = async(tid) => {
        if(!confirm("Listeden silinsin mi?")) return;
        await updateDoc(doc(db,"tournaments",tid), { participantIds: arrayRemove(currentUser.uid) });
    };

    document.getElementById('btnCreateTournament').onclick=async()=>{
        const n=document.getElementById('newTournamentName').value, c=parseInt(document.getElementById('playerCount').value);
        if(!n) return alert("Ä°sim giriniz");
        const slots=[]; for(let i=0;i<c;i++) slots.push({index:i, name:`Masa ${i+1}`, ownerId:null, avatar:'fa-chess-pawn', status:'open'});
        const ref=await addDoc(collection(db,"tournaments"),{ name:n, creatorId:currentUser.uid, status:'lobby', slots, matches:[], participantIds:[currentUser.uid], createdAt:new Date() });
        enterTournament(ref.id);
    };
    document.getElementById('btnJoinTournament').onclick=()=>{ const id=document.getElementById('joinCodeInput').value; if(id) enterTournament(id); };

    // TOURNAMENT LOGIC
    window.enterTournament = (id) => {
        currentTournamentId = id;
        unsubscribeTournament = onSnapshot(doc(db,"tournaments",id), snap=>{
            if(!snap.exists()) { alert("Turnuva silinmiÅŸ."); leaveTournament(); return; }
            const d=snap.data(); currentTournamentData=d; d.id=snap.id;
            
            if(d.status==='finished' && previousMatchesStr!=='finished') { 
                confetti({particleCount:150, spread:70, origin:{y:0.6}}); 
            } else if(d.status==='finished' && previousMatchesStr === "") {
                 confetti({particleCount:100, spread:60, origin:{y:0.6}}); 
            }

            const mStr=JSON.stringify(d.matches);
            if(previousMatchesStr && previousMatchesStr!==mStr && d.status==='active' && soundEnabled) realSound.play().catch(()=>{});
            previousMatchesStr = (d.status==='finished') ? 'finished' : mStr;

            if(d.status==='lobby') { renderLobby(d); switchView('view-lobby'); }
            else { renderFixtures(d); renderStandings(d); switchView('view-tournament'); }
        });
        initChat(id);
    };

    // LOBBY
    function renderLobby(d){
        document.getElementById('lobbyTitle').innerText = d.name;
        document.getElementById('shareCode').innerText = d.id;
        const isAdmin = (d.creatorId===currentUser.uid);
        document.getElementById('adminControls').style.display = isAdmin?'block':'none';
        
        const c=document.getElementById('lobbySlots'); c.innerHTML='';
        d.slots.forEach((s,i)=>{
            const isMe=(s.ownerId===currentUser.uid);
            let h=`<i class="fas ${s.ownerId?s.avatar:'fa-chair'}" style="font-size:2rem; margin-bottom:10px; color:${s.ownerId?(isMe?'var(--accent)':'var(--text-main)'):'#444'}"></i>
                   <div style="font-weight:bold; margin-bottom:5px;">${s.name}</div>`;
            
            if(s.status==='open') {
                const joined = d.slots.some(x=>x.ownerId===currentUser.uid);
                h += !joined ? `<button onclick="claimSlot(${i})">OTUR</button>` : `<span style="color:var(--text-muted)">BoÅŸ</span>`;
            } else {
                h += `<span style="color:${isMe?'var(--accent)':'var(--success)'}; font-weight:bold;">${isMe?'SEN':'HAZIR'}</span>`;
                if(isAdmin && !isMe) h += `<button class="kick-btn" onclick="kickPlayer(${i})"><i class="fas fa-times"></i></button>`;
            }
            const div=document.createElement('div'); div.className=`slot-item ${s.status==='taken'?'taken':''} ${isMe?'me':''}`; div.innerHTML=h;
            c.appendChild(div);
        });
    }

    window.claimSlot = async(i) => {
        const s=[...currentTournamentData.slots]; if(s[i].status!=='open') return;
        s[i]={ index:i, name:currentUser.displayName, ownerId:currentUser.uid, avatar:currentUser.photoURL||'fa-chess-pawn', status:'taken' };
        await updateDoc(doc(db,"tournaments",currentTournamentId), { slots:s, participantIds:arrayUnion(currentUser.uid) });
    };

    window.kickPlayer = async(i) => {
        if(!confirm("Oyuncuyu atmak istiyor musun?")) return;
        const s=[...currentTournamentData.slots];
        const uidToRemove = s[i].ownerId;
        s[i]={ index:i, name:`Masa ${i+1}`, ownerId:null, avatar:'fa-chess-pawn', status:'open' };
        await updateDoc(doc(db,"tournaments",currentTournamentId), { slots:s, participantIds:arrayRemove(uidToRemove) });
    };

    document.getElementById('btnStartTournament').onclick=async()=>{
        if(!confirm("BaÅŸlatÄ±lsÄ±n mÄ±?")) return;
        const s=currentTournamentData.slots; s.forEach((x,i)=>{ if(x.status==='open'){ x.name=`CPU ${i+1}`; x.status='cpu'; } });
        const m=[], n=s.length, p=s.map((_,i)=>i); let id=1;
        for(let r=1;r<n;r++){ for(let i=0;i<n/2;i++) m.push({id:id++, r, p1:p[i], p2:p[n-1-i], res:null, link:''}); p.splice(1,0,p.pop()); }
        [...m].forEach(x=>m.push({id:id++, r:x.r+n-1, p1:x.p2, p2:x.p1, res:null, link:''}));
        await updateDoc(doc(db,"tournaments",currentTournamentId), { status:'active', slots:s, matches:m });
    };

    document.getElementById('btnFinishTournament').onclick=async()=>{
        if(!confirm("Turnuva bitirilsin mi?")) return;
        await updateDoc(doc(db,"tournaments",currentTournamentId), { status:'finished' });
    };

    function renderFixtures(d){
        document.getElementById('activeTournamentTitle').innerText = d.name + (d.status==='finished'?' (Bitti)':'');
        const isAdmin = (d.creatorId===currentUser.uid);
        const isFin = d.status==='finished';
        const finishBtn = document.getElementById('btnFinishTournament');
        finishBtn.style.display = (isAdmin && !isFin) ? 'block' : 'none';

        const c=document.getElementById('fixturesList'); c.innerHTML='';
        const gr={}; d.matches.forEach(m=>{ if(!gr[m.r]) gr[m.r]=[]; gr[m.r].push(m); });
        
        Object.keys(gr).sort((a,b)=>a-b).forEach(r=>{
            const div=document.createElement('div');
            div.innerHTML=`<div style="background:var(--card-bg); padding:8px; margin-bottom:5px; border-left:4px solid var(--primary); font-weight:bold; color:var(--text-main);">TUR ${r}</div>`;
            gr[r].forEach(m=>{
                const p1=d.slots[m.p1], p2=d.slots[m.p2];
                const isP1=(p1.ownerId===currentUser.uid);
                const canEdit = isAdmin && !isFin; 
                
                let lnk=''; if(m.res!==null){
                    const watch = m.link ? `<a href="${m.link}" target="_blank" class="watch-btn"><i class="fas fa-eye"></i></a>` : '';
                    const inp = (m.res!==null && (isP1||isAdmin) && !isFin) ? `<input class="link-input" placeholder="Link..." value="${m.link||''}" onchange="upLink(${m.id},this.value)">` : '';
                    if(watch||inp) lnk=`<div class="link-area">${watch}${inp}</div>`;
                }

                div.innerHTML += `
                <div class="match-card">
                    <div class="match-player ${isP1?'me':''}"><i class="fas ${p1.avatar}"></i> ${p1.name}</div>
                    <select class="score-select" ${canEdit?'':'disabled'} onchange="upMatch(${m.id},this.value)">
                        <option value="">-</option><option value="1" ${m.res===1?'selected':''}>1 - 0</option>
                        <option value="0" ${m.res===0?'selected':''}>Â½ - Â½</option><option value="2" ${m.res===2?'selected':''}>0 - 1</option>
                    </select>
                    <div class="match-player right ${(p2.ownerId===currentUser.uid)?'me':''}">${p2.name} <i class="fas ${p2.avatar}"></i></div>
                    ${lnk}
                </div>`;
            });
            c.appendChild(div);
        });
    }

    window.upMatch = async(id,v)=>{ await updateDoc(doc(db,"tournaments",currentTournamentId), { matches:currentTournamentData.matches.map(m=>m.id===id?{...m,res:v===""?null:parseInt(v)}:m) }); };
    window.upLink = async(id,v)=>{ await updateDoc(doc(db,"tournaments",currentTournamentId), { matches:currentTournamentData.matches.map(m=>m.id===id?{...m,link:v.trim()}:m) }); };

    function renderStandings(d){
        const stats = d.slots.map((s,i)=>({ ...s, idx:i, p:0, w:0, d:0, l:0, pts:0, sb:0 }));
        d.matches.forEach(m=>{
            if(m.res !== null){
                stats[m.p1].p++; stats[m.p2].p++;
                if(m.res===1) { stats[m.p1].w++; stats[m.p1].pts+=1; stats[m.p2].l++; }
                else if(m.res===2) { stats[m.p2].w++; stats[m.p2].pts+=1; stats[m.p1].l++; }
                else { stats[m.p1].d++; stats[m.p1].pts+=0.5; stats[m.p2].d++; stats[m.p2].pts+=0.5; }
            }
        });
        d.matches.forEach(m=>{
            if(m.res !== null){
                if(m.res===1) stats[m.p1].sb += stats[m.p2].pts; 
                else if(m.res===2) stats[m.p2].sb += stats[m.p1].pts; 
                else { stats[m.p1].sb += 0.5 * stats[m.p2].pts; stats[m.p2].sb += 0.5 * stats[m.p1].pts; }
            }
        });
        stats.sort((a,b)=> b.pts - a.pts || b.sb - a.sb || b.w - a.w);
        const b=document.getElementById('standingsBody'); b.innerHTML='';
        const isFin = d.status==='finished';

        stats.forEach((s,rank)=>{
            let rowClass = '';
            if(isFin){
                if(rank===0) rowClass='rank-1';
                else if(rank===1) rowClass='rank-2';
                else if(rank===2) rowClass='rank-3';
            } else if(s.ownerId===currentUser.uid) rowClass='me'; 

            const tr=document.createElement('tr'); tr.className=rowClass;
            tr.innerHTML = `
                <td>${rank+1}</td>
                <td class="player-name-cell" onclick='showStats(${JSON.stringify(s)})' style="text-align:left;">
                    <i class="fas ${s.avatar}"></i> ${s.name} ${rank===0&&isFin?'ðŸ‘‘':''}
                </td>
                <td style="font-weight:bold; color:var(--primary); font-size:1.1rem;">${s.pts}</td>
                <td style="color:var(--text-muted); font-size:0.9rem;">${s.sb.toFixed(2)}</td>
                <td>${s.p}</td><td style="color:var(--success)">${s.w}</td><td>${s.d}</td><td style="color:var(--danger)">${s.l}</td>
            `;
            if(s.ownerId===currentUser.uid && !isFin) tr.style.background='rgba(0, 242, 255, 0.1)';
            b.appendChild(tr);
        });
    }

    window.showStats = (s) => {
        document.getElementById('modalAvatar').innerHTML = `<i class="fas ${s.avatar}"></i>`;
        document.getElementById('modalName').innerText = s.name;
        document.getElementById('statWins').innerText = s.w;
        document.getElementById('statDraws').innerText = s.d;
        document.getElementById('statLosses').innerText = s.l;
        document.getElementById('statPoints').innerText = s.pts;
        document.getElementById('statSB').innerText = s.sb.toFixed(2);
        const rate = s.p > 0 ? Math.round((s.w / s.p) * 100) : 0;
        document.getElementById('statRate').innerText = `%${rate}`;
        document.getElementById('statsModal').style.display = 'flex';
    };
    window.closeStats = () => document.getElementById('statsModal').style.display='none';
    window.onclick = (e) => { if(e.target == document.getElementById('statsModal')) closeStats(); }

    window.copyCode = () => { navigator.clipboard.writeText(document.getElementById('shareCode').innerText).then(()=>alert("KopyalandÄ±")); };
    window.leaveTournament = () => { if(unsubscribeTournament) unsubscribeTournament(); if(unsubscribeChat) unsubscribeChat(); currentTournamentId=null; hideChat(); switchView('view-dashboard'); };
    function switchView(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    window.showTab = (t) => { document.getElementById('tab-fixtures').style.display=t==='fixtures'?'block':'none'; document.getElementById('tab-standings').style.display=t==='standings'?'block':'none'; };
    window.openSettings = () => { renderAvatars('settingsAvatarGrid','settingsSelectedAvatar'); document.getElementById('settingsNameInput').value=currentUser.displayName; switchView('view-settings'); };
    
    // SAVE SETTINGS FIX (LOADING STATE)
    window.saveSettings = async() => { 
        const btn = document.getElementById('btnSaveSettings');
        const oldText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "KAYDEDÄ°LÄ°YOR...";
        try {
            await updateProfile(currentUser,{displayName:document.getElementById('settingsNameInput').value, photoURL:document.getElementById('settingsSelectedAvatar').value}); 
            switchView('view-dashboard'); 
        } catch(e){ alert(e.message); }
        finally {
            btn.disabled = false;
            btn.innerText = oldText;
        }
    };
    
    const cw=document.getElementById('chatWidget'), cb=document.getElementById('chatToggleBtn');
    cb.onclick=()=>{ cw.style.display='flex'; cb.style.display='none'; document.getElementById('chatBadge').style.display='none'; scrollChat(); };
    window.hideChat=()=>{ cw.style.display='none'; if(currentTournamentId) cb.style.display='flex'; };
    function initChat(tid){
        cb.style.display='flex'; const q=query(collection(db,`tournaments/${tid}/messages`),orderBy('createdAt','asc'));
        unsubscribeChat=onSnapshot(q,s=>{
            const d=document.getElementById('chatMessages'); d.innerHTML=''; let n=false;
            s.forEach(x=>{ const m=x.data(); const me=m.uid===currentUser.uid; d.innerHTML+=`<div class="chat-msg" style="text-align:${me?'right':'left'}"><strong style="color:${me?'var(--accent)':'var(--primary)'}">${m.user}:</strong> <span style="color:var(--text-muted)">${m.text}</span></div>`; n=true; });
            scrollChat(); if(n && cw.style.display==='none') document.getElementById('chatBadge').style.display='flex';
        });
    }
    document.getElementById('chatInputArea').onsubmit=async(e)=>{ e.preventDefault(); const i=document.getElementById('chatInput'); if(!i.value.trim()) return; await addDoc(collection(db,`tournaments/${currentTournamentId}/messages`),{text:i.value, user:currentUser.displayName, uid:currentUser.uid, createdAt:serverTimestamp()}); i.value=''; };
    function scrollChat(){ const d=document.getElementById('chatMessages'); d.scrollTop=d.scrollHeight; }

</script>
</body>
</html>